<!-- src/app/features/members/enrollment/enrollment.component.html -->

<div class="enrollment">
  <div class="enrollment__header">
    <div>
      <h1 class="enrollment__title">Enrolamiento Facial</h1>
      <p class="enrollment__subtitle">
        Sistema de registro y actualizaci√≥n biom√©trica
      </p>
    </div>
  </div>

  <!-- 1. B√öSQUEDA -->
  <mat-card class="step-card" *ngIf="currentView === 'search'">
    <div class="search-section">
      <mat-icon class="section-icon">person_search</mat-icon>
      <h2>Buscar Miembro</h2>
      <p>Ingresa el RUT o nombre del miembro para comenzar</p>

      <div class="search-input-group">
        <mat-form-field
          appearance="outline"
          floatLabel="always"
          class="input-field"
        >
          <mat-label>RUT o Nombre</mat-label>
          <mat-icon matPrefix>badge</mat-icon>
          <input
            #searchInput
            matInput
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchTermChange($event)"
            placeholder="12.345.678-9 o Nombre"
            (keyup.enter)="searchMember()"
          />
        </mat-form-field>

        <button
          mat-raised-button
          color="primary"
          (click)="searchMember()"
          [disabled]="isSearching"
          class="search-button"
        >
          <mat-spinner *ngIf="isSearching" diameter="20"></mat-spinner>
          <mat-icon *ngIf="!isSearching">search</mat-icon>
          {{ isSearching ? 'Buscando...' : 'Buscar' }}
        </button>
      </div>

      <p class="error-text" *ngIf="searchError">{{ searchError }}</p>

      <!-- RESULTADOS DE B√öSQUEDA -->
      <div class="search-results" *ngIf="searchResults.length > 0">
        <p class="search-results__title">
          Coincidencias ({{ searchResults.length }})
        </p>

        <div
          class="search-results__item"
          *ngFor="let m of searchResults"
          (click)="selectMember(m)"
        >
          <div class="search-results__item-main">
            <span class="search-results__name">{{ m.fullName }}</span>
            <span class="search-results__rut">RUT: {{ m.rut }}</span>
          </div>
          <div class="search-results__meta">
            <span class="search-results__membership">
              {{ m.membershipName || m.membershipType || 'Sin membres√≠a' }}
            </span>
            <span
              class="search-results__status"
              [class]="getMembershipStatusClass(m.membershipStatus)"
            >
              {{
                m.membershipStatus === 'active'
                  ? 'Activa'
                  : m.membershipStatus === 'inactive'
                  ? 'Inactiva'
                  : 'Expirada'
              }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </mat-card>

  <!-- 2. INFORMACI√ìN DEL MIEMBRO -->
  <mat-card
    class="step-card"
    *ngIf="currentView === 'member-info' && memberData as m"
  >
    <div class="member-section">
      <div class="member-header">
        <div class="member-avatar">
          <span class="avatar-text">
            {{ getInitials(m.fullName) }}
          </span>
        </div>
        <div class="member-details">
          <h2>{{ m.fullName }}</h2>
          <p class="member-email">{{ m.email }}</p>
          <p class="member-rut">RUT: {{ m.rut }}</p>
          <p class="member-phone" *ngIf="m.phone">
            Tel√©fono: {{ m.phone }}
          </p>
        </div>
      </div>

      <div class="member-status">
        <div class="status-item">
          <span class="status-label">Membres√≠a:</span>
          <mat-chip [class]="getMembershipStatusClass(m.membershipStatus)">
            {{ m.membershipName || m.membershipType || 'Sin membres√≠a' }}
            <span class="status-indicator">
              {{
                m.membershipStatus === 'active'
                  ? '‚óè Activa'
                  : m.membershipStatus === 'inactive'
                  ? '‚óè Inactiva'
                  : '‚óè Expirada'
              }}
            </span>
          </mat-chip>
        </div>

        <div class="status-item">
          <span class="status-label">Enrolamiento:</span>
          <mat-chip [class]="getEnrollmentStatusClass(m.enrollmentStatus)">
            {{
              m.enrollmentStatus === 'enrolled'
                ? '‚úì Enrolado'
                : m.enrollmentStatus === 'locked'
                ? 'üîí Bloqueado'
                : '‚óã No enrolado'
            }}
          </mat-chip>
        </div>
      </div>

      <!-- BLOQUEO -->
      <div class="lock-warning" *ngIf="m.enrollmentLocked">
        <mat-icon>lock</mat-icon>
        <div>
          <h3>Enrolamiento Bloqueado</h3>
          <p>
            Este usuario tiene el enrolamiento bloqueado. Debe desbloquearse
            para poder enrolar.
          </p>
          <button mat-raised-button color="warn" (click)="openUnlockDialog()">
            <mat-icon>lock_open</mat-icon>
            Desbloquear
          </button>
        </div>
      </div>

      <!-- MEMBRES√çA INACTIVA -->
      <div class="membership-warning" *ngIf="m.membershipStatus !== 'active'">
        <mat-icon>warning</mat-icon>
        <div>
          <h3>Membres√≠a Inactiva</h3>
          <p>El usuario debe tener una membres√≠a activa para poder enrolarse</p>
        </div>
      </div>

      <!-- ACCIONES -->
      <div class="member-actions">
        <button mat-stroked-button class="search-another-btn" (click)="reset()">
          <mat-icon>arrow_back</mat-icon>
          Buscar Otro
        </button>

        <button
          mat-raised-button
          color="primary"
          [disabled]="!canEnroll()"
          (click)="startEnrollment()"
        >
          <mat-icon>face</mat-icon>
          {{
            operationType === 'new'
              ? 'Enrolar rostro'
              : 'Reenrolar rostro'
          }}
        </button>
      </div>
    </div>
  </mat-card>

  <!-- 3. C√ÅMARA -->
  <mat-card class="step-card" *ngIf="currentView === 'camera'">
    <div class="camera-section">
      <h2>
        {{
          operationType === 'new'
            ? 'Capturar Rostro'
            : 'Actualizar Rostro'
        }}
      </h2>
      <p>Posiciona tu rostro dentro del c√≠rculo</p>

      <div class="camera-container">
        <video #videoElement autoplay playsinline></video>
        <canvas #canvasElement style="display: none"></canvas>

        <div class="face-overlay" [class.face-detected]="faceDetected">
          <div class="face-circle"></div>
          <p class="face-instruction">
            {{ faceDetected ? '‚úì Rostro detectado' : 'Centra tu rostro' }}
          </p>
        </div>
      </div>

      <div class="camera-controls">
        <button
          mat-stroked-button
          class="search-another-btn"
          (click)="currentView = 'member-info'; stopCamera()"
        >
          <mat-icon>arrow_back</mat-icon>
          Cancelar
        </button>
        <button
          mat-raised-button
          color="accent"
          [disabled]="!faceDetected"
          (click)="captureImage()"
        >
          <mat-icon>camera_alt</mat-icon>
          Capturar
        </button>
      </div>
    </div>
  </mat-card>

  <!-- 4. REVISI√ìN -->
  <mat-card class="step-card" *ngIf="currentView === 'review'">
    <div class="review-section">
      <h2>Revisar Captura</h2>
      <p>Verifica que la imagen sea clara</p>

      <div class="captured-preview">
        <img [src]="capturedImage" alt="Rostro capturado" />
      </div>

      <div class="review-controls">
        <button mat-stroked-button (click)="retakePhoto()">
          <mat-icon>refresh</mat-icon>
          Tomar Otra
        </button>
        <button mat-raised-button color="primary" (click)="confirmEnrollment()">
          <mat-icon>check_circle</mat-icon>
          Confirmar
        </button>
      </div>
    </div>
  </mat-card>

  <!-- 5. PROCESANDO -->
  <mat-card class="step-card" *ngIf="currentView === 'processing'">
    <div class="processing-section">
      <mat-spinner diameter="60"></mat-spinner>
      <h2>Procesando</h2>
      <p>{{ processingMessage }}</p>
    </div>
  </mat-card>

  <!-- 6. √âXITO -->
  <mat-card
    class="step-card step-card--success"
    *ngIf="currentView === 'success'"
  >
    <div class="success-section">
      <mat-icon class="success-icon">check_circle</mat-icon>
      <h2>{{ successMessage }}</h2>
      <p *ngIf="memberData">
        {{ memberData.fullName || ('Usuario ' + memberData.rut) }} enrolado
        correctamente
      </p>
      <button mat-raised-button color="primary" (click)="reset()">
        <mat-icon>add</mat-icon>
        Enrolar Otro
      </button>
    </div>
  </mat-card>

  <!-- 7. ERROR -->
  <mat-card
    class="step-card step-card--error"
    *ngIf="currentView === 'error'"
  >
    <div class="error-section">
      <mat-icon class="error-icon">error</mat-icon>
      <h2>Error</h2>
      <p>{{ errorMessage }}</p>
      <button mat-raised-button color="warn" (click)="reset()">
        <mat-icon>refresh</mat-icon>
        Intentar de Nuevo
      </button>
    </div>
  </mat-card>

  <!-- MODAL DE DESBLOQUEO -->
  <div class="unlock-modal" *ngIf="showUnlockDialog">
    <div class="unlock-modal__overlay" (click)="closeUnlockDialog()"></div>
    <div class="unlock-modal__content">
      <div class="unlock-modal__header">
        <h2>Desbloquear Enrolamiento</h2>
        <button mat-icon-button (click)="closeUnlockDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="unlock-modal__body">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Raz√≥n del desbloqueo</mat-label>
          <textarea
            matInput
            [(ngModel)]="unlockReason"
            rows="3"
            placeholder="Ej: Cambio est√©tico, cirug√≠a facial, etc."
          ></textarea>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Contrase√±a de Admin</mat-label>
          <input
            matInput
            type="password"
            [(ngModel)]="unlockPassword"
            (keyup.enter)="unlockEnrollment()"
          />
          <mat-icon matPrefix>key</mat-icon>
        </mat-form-field>

        <p class="error-text" *ngIf="unlockError">{{ unlockError }}</p>

        <div class="modal-actions">
          <button mat-stroked-button (click)="closeUnlockDialog()">
            Cancelar
          </button>
          <button
            mat-raised-button
            color="primary"
            (click)="unlockEnrollment()"
          >
            <mat-icon>lock_open</mat-icon>
            Desbloquear
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
