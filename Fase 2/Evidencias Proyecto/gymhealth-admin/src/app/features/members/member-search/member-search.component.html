<div class="member-search">
  <div class="member-search__header">
    <div>
      <h1 class="member-search__title">Búsqueda de Miembros</h1>
      <p class="member-search__subtitle">
        Busca y gestiona información de miembros del gimnasio
      </p>
    </div>
  </div>

  <!-- 1. BUSCADOR (solo si NO hay miembro seleccionado) -->
  @if (!selectedMember()) {
    <mat-card class="step-card">
      <div class="search-section">
        <mat-icon class="section-icon">person_search</mat-icon>
        <h2>Buscar Miembro</h2>
        <p>Ingresa el RUT, nombre, email o teléfono del miembro</p>

        <div class="search-input-group">
          <mat-form-field
            appearance="outline"
            floatLabel="always"
            class="input-field"
          >
            <mat-label>RUT o nombre</mat-label>
            <mat-icon matPrefix>search</mat-icon>
            <input
              matInput
              [formControl]="searchControl"
              placeholder="Ej: 12.345.678-9 o Juan Pérez"
              (input)="onSearchInput($event)"
              (keyup.enter)="onEnter()"
              [disabled]="isSaving()"
              maxlength="50"
            />
          </mat-form-field>
        </div>

        <!-- Lista de resultados / sugerencias -->
        @if (isSearching()) {
          <p class="search-hint">Buscando miembros...</p>
        }

        @if (!isSearching() && searchResults().length > 0) {
          <div class="search-results">
            @for (member of searchResults(); track member.id) {
              <button
                type="button"
                class="search-result-item"
                (click)="selectMember(member)"
              >
                <div class="result-main">
                  <span class="result-name">
                    {{ member.nombre }} {{ member.apellido }}
                  </span>
                  <span class="result-rut">
                    RUT: {{ member.rut }}
                  </span>
                </div>
                <div class="result-extra">
                  <span class="result-email">{{ member.email }}</span>
                  <span
                    class="result-status"
                    [class.result-status--activa]="member.estadoMembresia === 'ACTIVA'"
                    [class.result-status--vencida]="member.estadoMembresia === 'VENCIDA'"
                  >
                    {{ member.estadoMembresia }}
                  </span>
                </div>
              </button>
            }
          </div>
        }

        @if (
          !isSearching()
          && (searchControl.value || '').trim().length >= 2
          && searchResults().length === 0
        ) {
          <p class="search-hint">
            No se encontraron miembros para ese criterio.
          </p>
        }
      </div>
    </mat-card>
  }

  <!-- 2. INFORMACIÓN DEL MIEMBRO SELECCIONADO -->
  @if (selectedMember()) {
    <mat-card class="step-card">
      <div class="member-section">
        <div class="member-header">
          <div class="member-avatar">
            {{ selectedMember()!.nombre.charAt(0) }}{{ selectedMember()!.apellido.charAt(0) }}
          </div>
          <div class="member-details">
            <h2>{{ selectedMember()!.nombre }} {{ selectedMember()!.apellido }}</h2>
            <p class="member-email">{{ selectedMember()!.email }}</p>
            <p class="member-rut">RUT: {{ selectedMember()!.rut }}</p>
          </div>
        </div>

        <!-- Información de Contacto (solo lectura) -->
        <div class="info-section">
          <div class="section-header">
            <h3>
              <mat-icon>contact_mail</mat-icon>
              Información de Contacto
            </h3>
          </div>

          <div class="info-grid">
            <div class="info-item">
              <mat-icon>email</mat-icon>
              <div>
                <span class="label">Email</span>
                <span class="value">{{ selectedMember()!.email }}</span>
              </div>
            </div>

            <div class="info-item">
              <mat-icon>phone</mat-icon>
              <div>
                <span class="label">Teléfono</span>
                <span class="value">{{ selectedMember()!.telefono || '-' }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Membresía -->
        <div class="info-section">
          <h3>
            <mat-icon>card_membership</mat-icon>
            Membresía
          </h3>
          <div class="member-status">
            <div class="status-item">
              <span class="status-label">Estado:</span>
              <mat-chip
                [class]="'status--' + getStatusColor(selectedMember()!.estadoMembresia)"
              >
                {{ selectedMember()!.estadoMembresia }}
                <span class="status-indicator">
                  {{ selectedMember()!.estadoMembresia === 'ACTIVA' ? '●' : '○' }}
                </span>
              </mat-chip>
            </div>
            <div class="status-item">
              <span class="status-label">Tipo:</span>
              <span class="status-value">{{ selectedMember()!.tipoMembresia }}</span>
            </div>
          </div>

          <div class="info-grid">
            <div class="info-item" [class.warning]="getDaysUntilExpiration() <= 30">
              <mat-icon>event</mat-icon>
              <div>
                <span class="label">Vencimiento</span>
                <span class="value">
                  {{ formatDate(selectedMember()!.fechaVencimiento) }}
                </span>
                @if (getDaysUntilExpiration() <= 30 && getDaysUntilExpiration() > 0) {
                  <span class="hint">Vence en {{ getDaysUntilExpiration() }} días</span>
                }
                @if (getDaysUntilExpiration() <= 0 && selectedMember()!.fechaVencimiento) {
                  <span class="hint">Membresía vencida</span>
                }
              </div>
            </div>
            <div class="info-item">
              <mat-icon>payments</mat-icon>
              <div>
                <span class="label">Último pago</span>
                <span class="value">
                  {{ formatDate(selectedMember()!.ultimoPago) }}
                </span>
              </div>
            </div>
          </div>

          <!-- Plan limitado por días -->
          @if (hasLimitedPlan()) {
            <div class="limited-plan">
              <div class="info-item">
                <mat-icon>calendar_today</mat-icon>
                <div>
                  <span class="label">Uso de días</span>
                  @if (!isWithoutDays()) {
                    <span class="value">
                      Días usados: {{ getUsedDays() }} /
                      Días disponibles: {{ getAvailableDays() }}
                    </span>
                  } @else {
                    <span class="value warning">
                      Todos los días disponibles de la membresía ya fueron utilizados.
                    </span>
                  }
                </div>
              </div>
            </div>
          }

          @if (hasDebt()) {
            <div class="lock-warning">
              <mat-icon>account_balance_wallet</mat-icon>
              <div>
                <h3>Deuda Pendiente</h3>
                <p>{{ formatCurrency(selectedMember()!.deudaPendiente) }}</p>
                <button mat-raised-button color="primary" (click)="viewPaymentHistory()">
                  Ver historial de pagos
                </button>
              </div>
            </div>
          }
        </div>

        <!-- Control de Acceso -->
        <div class="info-section">
          <h3>
            <mat-icon>sensor_door</mat-icon>
            Control de Acceso
          </h3>
          <div class="info-grid">
            <div class="info-item">
              <mat-icon>schedule</mat-icon>
              <div>
                <span class="label">Último acceso</span>
                @if (selectedMember()!.ultimoAcceso) {
                  <span class="value">
                    {{ formatDateTime(selectedMember()!.ultimoAcceso!) }}
                  </span>
                } @else {
                  <span class="value no-data">Sin registros</span>
                }
              </div>
            </div>
            <div class="info-item">
              <mat-icon>trending_up</mat-icon>
              <div>
                <span class="label">Visitas del mes</span>
                <span class="value">
                  {{ selectedMember()!.totalAccesosUltimoMes }} accesos
                </span>
              </div>
            </div>
          </div>

          <!-- Estado de bloqueo -->
          @if (isBlocked()) {
            <div class="lock-warning">
              <mat-icon>block</mat-icon>
              <div>
                <h3>Usuario bloqueado</h3>
                <p>
                  Motivo del bloqueo:
                  <strong>
                    {{
                      selectedMember()!.motivoBloqueo
                        || 'Bloqueo manual desde backoffice'
                    }}
                  </strong>
                </p>
                <p class="lock-status">
                  Estado de acceso actual:
                  <strong>{{ selectedMember()!.accessStatus }}</strong>
                </p>
                <button
                  mat-raised-button
                  color="primary"
                  (click)="unblockMember()"
                  [disabled]="isSaving()"
                >
                  <mat-icon>lock_open</mat-icon>
                  Desbloquear
                </button>
              </div>
            </div>
          } @else {
            <div class="lock-info">
              <mat-icon>verified_user</mat-icon>
              <div>
                <h3>Acceso habilitado</h3>
                <p>
                  Este usuario puede ingresar normalmente al gimnasio.
                  Si es necesario, puedes bloquear su acceso.
                </p>
                <button
                  mat-raised-button
                  color="warn"
                  (click)="blockMember()"
                  [disabled]="isSaving()"
                >
                  <mat-icon>block</mat-icon>
                  Bloquear usuario
                </button>
              </div>
            </div>
          }
        </div>

        <!-- Historial de Acceso -->
        <div class="info-section">
          <h3>
            <mat-icon>history</mat-icon>
            Historial de Acceso Reciente
          </h3>
          @if (accessHistory().length > 0) {
            <div class="timeline">
              @for (access of accessHistory(); track access.id) {
                <div
                  class="timeline-item"
                  [class.exit]="access.tipo === 'SALIDA'"
                >
                  <div
                    class="timeline-dot"
                    [class.exit]="access.tipo === 'SALIDA'"
                    [class.granted]="access.resultado === 'GRANTED'"
                    [class.denied]="access.resultado === 'DENIED'"
                  >
                    <mat-icon>
                      {{
                        access.tipo === 'ENTRADA'
                          ? 'login'
                          : 'logout'
                      }}
                    </mat-icon>
                  </div>
                  <div class="timeline-content">
                    <div class="timeline-header">
                      <span class="timeline-type">{{ access.tipo }}</span>
                      <span class="timeline-time">{{ access.hora }}</span>
                    </div>
                    <span class="timeline-location">
                      {{ access.sucursal }}
                    </span>
                    <span class="timeline-date">
                      {{ formatDate(access.fecha) }}
                    </span>
                    <span
                      class="timeline-result"
                      [class.timeline-result--granted]="
                        access.resultado === 'GRANTED'
                      "
                      [class.timeline-result--denied]="
                        access.resultado === 'DENIED'
                      "
                    >
                      {{
                        access.resultado === 'GRANTED'
                          ? 'Acceso PERMITIDO'
                          : 'Acceso DENEGADO'
                      }}
                    </span>
                  </div>
                </div>
              }
            </div>
          } @else {
            <div class="membership-warning">
              <mat-icon>info</mat-icon>
              <div>
                <h3>Sin Historial</h3>
                <p>No hay registros de acceso disponibles</p>
              </div>
            </div>
          }
        </div>

        <!-- ACCIONES -->
        <div class="member-actions">
          <button
            mat-stroked-button
            class="search-another-btn"
            (click)="clearSearch()"
            [disabled]="isSaving()"
          >
            <mat-icon>arrow_back</mat-icon>
            Limpiar búsqueda
          </button>
        </div>
      </div>
    </mat-card>
  }
</div>
