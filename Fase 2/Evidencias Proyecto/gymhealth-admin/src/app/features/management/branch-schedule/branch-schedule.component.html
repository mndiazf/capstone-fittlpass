<!-- src/app/features/management/branch-schedule/branch-schedule.component.html -->

<div class="branch-schedule">
  <!-- Header -->
  <div class="branch-schedule__header">
    <div class="header__content">
      <h1 class="header__title">
        <mat-icon class="header__icon">schedule</mat-icon>
        Horarios de Sucursal
      </h1>
      <p class="header__subtitle">
        Gestiona los horarios de apertura y cierre de tu sucursal
      </p>
    </div>
  </div>

  <!-- Sucursal actual (JWT) -->
  @if (currentBranch(); as branch) {

    <mat-card class="current-branch-card">
      <mat-card-content>
        <div class="current-branch">
          <mat-icon class="current-branch__icon">store</mat-icon>

          <div class="current-branch__info">
            <h3>{{ branch.name }}</h3>
            <p>
              {{ branch.address || 'Sucursal asignada' }}
              <ng-container *ngIf="branch.city">
                , {{ branch.city }}
              </ng-container>
              <ng-container *ngIf="branch.region">
                , {{ branch.region }}
              </ng-container>
            </p>

            <!-- Estado sucursal + botón abrir/cerrar -->
            <!-- Estado sucursal + botón abrir/cerrar -->
            @if (branchStatus(); as status) {
              <div class="current-branch__status">
                <mat-chip
                  class="status-chip"
                  [class.status-chip--open]="status.isOpen"
                  [class.status-chip--closed]="!status.isOpen">
                  <mat-icon>
                    {{ status.isOpen ? 'lock_open' : 'lock' }}
                  </mat-icon>
                  {{ status.isOpen ? 'Sucursal abierta' : 'Sucursal cerrada' }}
                </mat-chip>

                <button
                  mat-stroked-button
                  color="primary"
                  class="branch-toggle-btn"
                  [ngClass]="status.isOpen ? 'branch-toggle-btn--close' : 'branch-toggle-btn--open'"
                  (click)="toggleBranchStatus()"
                  [disabled]="isChangingBranchStatus()">
                  <mat-icon>
                    {{ status.isOpen ? 'lock' : 'lock_open' }}
                  </mat-icon>
                  {{ status.isOpen ? 'Cerrar sucursal' : 'Abrir sucursal' }}
                </button>
              </div>
            } @else {
              <div class="current-branch__status">
                <mat-chip class="status-chip status-chip--unknown">
                  <mat-icon>help_outline</mat-icon>
                  Estado no disponible
                </mat-chip>
              </div>
            }

          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Horarios regulares -->
    <mat-card class="schedule-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>event_repeat</mat-icon>
          Horarios Regulares
        </mat-card-title>
        <mat-card-subtitle>
          Configura los horarios de apertura para cada día de la semana
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        @if (isLoading()) {
          <div class="loading-state">
            <mat-icon class="loading-icon">hourglass_empty</mat-icon>
            <p>Cargando horarios...</p>
          </div>
        } @else {
          <div class="schedule-table">
            @for (schedule of schedules(); track schedule.dayOfWeek) {
              <div class="schedule-row"
                   [class.schedule-row--closed]="!schedule.openTime && !schedule.closeTime">

                <!-- Día -->
                <div class="schedule-row__day">
                  <mat-icon class="day-icon">calendar_today</mat-icon>
                  <span class="day-name">
                    {{ dayNames[schedule.dayOfWeek] }}
                  </span>
                </div>

                <!-- Horarios (si no hay hora => día sin horario) -->
                <div class="schedule-row__times">
                  <mat-form-field appearance="outline" class="time-field">
                    <mat-label>Apertura</mat-label>
                    <input
                      matInput
                      type="time"
                      [value]="schedule.openTime || ''"
                      (change)="onTimeChange(
                        schedule,
                        'openTime',
                        $any($event.target).value
                      )" />
                    <mat-icon matPrefix>login</mat-icon>
                  </mat-form-field>

                  <span class="time-separator">—</span>

                  <mat-form-field appearance="outline" class="time-field">
                    <mat-label>Cierre</mat-label>
                    <input
                      matInput
                      type="time"
                      [value]="schedule.closeTime || ''"
                      (change)="onTimeChange(
                        schedule,
                        'closeTime',
                        $any($event.target).value
                      )" />
                    <mat-icon matPrefix>logout</mat-icon>
                  </mat-form-field>
                </div>
              </div>
            }
          </div>

          <!-- Botón guardar -->
          <div class="schedule-actions">
            <button
              mat-raised-button
              color="primary"
              (click)="saveSchedules()"
              [disabled]="isSaving()">
              <mat-icon>save</mat-icon>
              Guardar horarios
            </button>
          </div>
        }
      </mat-card-content>
    </mat-card>

  } @else if (!isLoading()) {
    <!-- Sin sucursal asignada en el token -->
    <div class="empty-state-main">
      <mat-icon>error</mat-icon>
      <h3>No se encontró una sucursal asignada</h3>
      <p>Revisa tus credenciales o vuelve a iniciar sesión.</p>
    </div>
  }
</div>
