<!-- src/app/features/auth/checkout/checkout.component.html -->
<div class="checkout-page">
  <div class="checkout-container">
    <!-- Header con botón volver -->
    <div class="checkout-header">
      <button class="back-btn" (click)="step === 'payment' ? goBackToRegister() : goBack()">
        <svg viewBox="0 0 24 24">
          <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
        Volver
      </button>
      <img src="assets/logo-gymhealth.png" alt="GymHealth" class="logo" />
    </div>

    <!-- STEP 1: REGISTRO -->
    @if (step === 'register') {
      <div class="checkout-content">
        <!-- Formulario Izquierda -->
        <div class="form-section">
          <h1 class="title">Completa tu registro</h1>
          <p class="subtitle">Ingresa tus datos para continuar con la compra</p>

          <form [formGroup]="f" (ngSubmit)="submit()" novalidate>
            <!-- Fila 1: Nombre / Segundo nombre -->
            <div class="row-2">
              <div class="field">
                <label>Nombre *</label>
                <input type="text" formControlName="firstName" 
                       [class.invalid]="firstName?.touched && firstName?.invalid"/>
              </div>
              <div class="field">
                <label>Segundo nombre</label>
                <input type="text" formControlName="middleName" />
              </div>
            </div>

            <!-- Fila 2: Apellido / Segundo apellido -->
            <div class="row-2">
              <div class="field">
                <label>Apellido *</label>
                <input type="text" formControlName="lastName"
                       [class.invalid]="lastName?.touched && lastName?.invalid"/>
              </div>
              <div class="field">
                <label>Segundo apellido</label>
                <input type="text" formControlName="secondLastName" />
              </div>
            </div>

            <!-- Rut -->
            <div class="field">
              <label>Rut *</label>
              <input type="text" formControlName="rut" placeholder="12.345.678-9"
                     [class.invalid]="rut?.touched && rut?.invalid"/>
              <small class="hint">Formato chileno con dígito verificador</small>
            </div>

            <!-- Email -->
            <div class="field">
              <label>Email *</label>
              <input type="email" formControlName="email" placeholder="correo@dominio.com"
                     [class.invalid]="email?.touched && email?.invalid"/>
            </div>

            <!-- Teléfono -->
            <div class="field">
              <label>Teléfono *</label>
              <input type="tel" formControlName="phone" placeholder="+56 9 1234 5678"
                     [class.invalid]="phone?.touched && phone?.invalid"/>
            </div>

            <!-- Contraseñas -->
            <div formGroupName="passwordGroup">
              <div class="field">
                <label>Contraseña *</label>
                <input type="password" formControlName="password"
                       [class.invalid]="(passGroup?.get('password')?.touched && passGroup?.get('password')?.invalid) || passGroup?.errors?.['mismatch']"/>
                <small class="hint">Mínimo 8 caracteres, una mayúscula, una minúscula y un número</small>
              </div>
              <div class="field">
                <label>Repite tu contraseña *</label>
                <input type="password" formControlName="confirm"
                       [class.invalid]="(passGroup?.get('confirm')?.touched && passGroup?.get('confirm')?.invalid) || passGroup?.errors?.['mismatch']"/>
              </div>

              @if (passGroup?.touched && passGroup?.errors?.['mismatch']) {
                <div class="error">Las contraseñas no coinciden</div>
              }
            </div>

            <!-- Sucursal (SOLO para ONECLUB) -->
            @if (isOneClubSelected) {
              <div class="field">
                <label>Sucursal *</label>
                <select formControlName="branchId" [class.invalid]="branchId?.touched && branchId?.invalid">
                  <!-- placeholder: ngValue null (no value="") -->
                  <option [ngValue]="null">Selecciona una sucursal</option>
                  @for (b of branches; track b.id) {
                    <option [ngValue]="b.id">{{ b.name }} — {{ b.address }}</option>
                  }
                </select>
                @if (branchId?.touched && branchId?.invalid) {
                  <div class="error">Selecciona una sucursal</div>
                }
                <small class="hint">Tu plan ONECLUB quedará asociado a esta sucursal.</small>
              </div>
            }

            <!-- Botón -->
            <button type="submit" class="submit-btn" [disabled]="f.invalid">
              Continuar con el pago
            </button>

            @if (errorMsg) {
              <div class="error" style="margin-top:12px">{{ errorMsg }}</div>
            }
          </form>
        </div>

        <!-- Resumen Derecha -->
        @if (selectedMembership) {
          <div class="summary-section">
            <div class="summary-card">
              <h2 class="summary-title">Resumen de compra</h2>
              
              <div class="plan-badge">{{ selectedMembership.discount }}</div>
              <h3 class="plan-name">{{ selectedMembership.name }}</h3>
              
              <div class="plan-features">
                <p class="features-title">Incluye:</p>
                <ul>
                  @for (feature of selectedMembership.features; track feature) {
                    <li>
                      <svg viewBox="0 0 24 24">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                      </svg>
                      {{ feature }}
                    </li>
                  }
                </ul>
              </div>

              <div class="pricing-summary">
                @if (isOneClubSelected) {
                  <div class="price-row">
                    <span class="label">Sucursal:</span>
                    <span class="value">
                      {{ branchId?.value ? branchName(branchId?.value) : 'Selecciona una' }}
                    </span>
                  </div>
                }
                <div class="price-row">
                  <span class="label">Precio mensual:</span>
                  <span class="value">{{ selectedMembership.monthlyPrice }}</span>
                </div>
                <div class="price-row total">
                  <span class="label">Total:</span>
                  <span class="value">{{ selectedMembership.price }}</span>
                </div>
              </div>

              <div class="security-note">
                <svg viewBox="0 0 24 24">
                  <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                </svg>
                <span>Pago seguro y protegido</span>
              </div>
            </div>
          </div>
        }
      </div>
    }

    <!-- STEP 2: PAGO -->
    @if (step === 'payment') {
      <div class="checkout-content">
        <div class="form-section">
          <h1 class="title">Información de pago</h1>
          <p class="subtitle">Ingresa los datos de tu tarjeta</p>

          <form [formGroup]="paymentForm" (ngSubmit)="submitPayment()" novalidate>
            <div class="field">
              <label>Número de tarjeta *</label>
              <input type="text" formControlName="cardNumber" 
                     placeholder="1234 5678 9012 3456"
                     maxlength="19"
                     [class.invalid]="cardNumber?.touched && cardNumber?.invalid"/>
            </div>

            <div class="field">
              <label>Nombre en la tarjeta *</label>
              <input type="text" formControlName="cardName" 
                     placeholder="JUAN PEREZ"
                     [class.invalid]="cardName?.touched && cardName?.invalid"/>
            </div>

            <div class="row-2">
              <div class="field">
                <label>Fecha de expiración *</label>
                <input type="text" formControlName="expiryDate" 
                       placeholder="MM/AA"
                       maxlength="5"
                       [class.invalid]="expiryDate?.touched && expiryDate?.invalid"/>
              </div>
              <div class="field">
                <label>CVV *</label>
                <input type="text" formControlName="cvv" 
                       placeholder="123"
                       maxlength="4"
                       [class.invalid]="cvv?.touched && cvv?.invalid"/>
              </div>
            </div>

            <button type="submit" class="submit-btn" [disabled]="paymentForm.invalid">
              Pagar {{ selectedMembership?.price }}
            </button>
          </form>
        </div>

        @if (selectedMembership) {
          <div class="summary-section">
            <div class="summary-card">
              <h2 class="summary-title">Resumen de compra</h2>
              
              <div class="plan-badge">{{ selectedMembership.discount }}</div>
              <h3 class="plan-name">{{ selectedMembership.name }}</h3>
              
              <div class="pricing-summary">
                <div class="price-row total">
                  <span class="label">Total a pagar:</span>
                  <span class="value">{{ selectedMembership.price }}</span>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    }

    <!-- STEP 3: PROCESANDO -->
    @if (step === 'processing') {
      <div class="processing-container">
        <div class="spinner"></div>
        <h2>Procesando tu pago...</h2>
        <p>Por favor espera un momento</p>
      </div>
    }

    <!-- STEP 4: ÉXITO -->
    @if (step === 'success') {
      <div class="success-container">
        <div class="success-icon">
          <svg viewBox="0 0 24 24">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
          </svg>
        </div>
        <h2>¡Pago procesado correctamente!</h2>
        <p>Tu membresía ha sido activada</p>
        <button class="submit-btn" (click)="finishCheckout()">
          Continuar
        </button>
      </div>
    }
  </div>
</div>
